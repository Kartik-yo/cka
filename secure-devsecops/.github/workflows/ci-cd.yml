name: CI/CD Secure Pipeline

on:
  workflow_dispatched: {}

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/myapp
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.build.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go (example)
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'
      
      - name: Run unit tests
        run: |
          cd src/app
          go test ./... -v

      - name: SonarQube Scan
        uses: sonarsource/sonarcloud-github-action@v1
        with:
          # If using SonarCloud replace with sonarcloud action and token config
          args: >
            -Dsonar.projectKey=myorg_myapp
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }}
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      - name: Build Docker image
        id: build
        run: |
          docker build -t $IMAGE_NAME:$IMAGE_TAG -f docker/Dockerfile .
          echo "::set-output name=image::$IMAGE_NAME:$IMAGE_TAG"

      - name: Login to registry
        run: |
          echo "${{ secrets.GITHUB_REGISTRY_PASSWORD }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin

      - name: Push image
        run: docker push $IMAGE_NAME:$IMAGE_TAG

  container-scan:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin

      - name: Run Trivy image scan
        id: trivy
        run: |
          trivy image --exit-code 1 --severity HIGH,CRITICAL ${{ needs.build-and-test.outputs.image }} || true
        continue-on-error: false

  deploy-test-and-dast:
    needs: container-scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: '1.28.0'

      - name: Configure Kubeconfig
        run: |
          echo "${{ secrets.KUBE_CONFIG }}" | base64 --decode > $HOME/.kube/config

      - name: Deploy to test namespace
        run: |
          kubectl create ns test || true
          kubectl -n test apply -f k8s/base/deployment.yaml
          kubectl -n test apply -f k8s/base/service.yaml
          kubectl -n test rollout status deploy/myapp --timeout=120s

      - name: Wait for service
        run: |
          # crude wait; better: check readiness probe
          for i in {1..30}; do
            kubectl -n test get pods -l app=myapp -o jsonpath='{.items[0].status.phase}' | grep -q Running && break
            sleep 5
          done

      - name: Run OWASP ZAP baseline & active scan
        uses: zaproxy/action-full-scan@v0.4.0
        with:
          target: 'http://myapp.test.svc.cluster.local:8080'   # replace with accessible endpoint / port mapping or use port-forward
          rules_file_name: 'zap-rules/rules.json'
          fail_build: true

      - name: Cleanup test namespace
        if: ${{ always() }}
        run: |
          kubectl delete ns test || true
